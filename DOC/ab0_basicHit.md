<<<<<<< HEAD
# Ð¤Ð¾Ñ€Ð¼ÑƒÐ»Ð° Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð³Ð¾ ÑƒÐ´Ð°Ñ€Ð° (ab0)

## 1. Ð‘Ð°Ð·Ð¾Ð²Ð¾Ðµ Ð¾ÐºÐ½Ð¾ ÑƒÑ€Ð¾Ð½Ð°

Ð‘ÐµÑ€Ñ‘Ð¼ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¸ Ð¼Ð°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑƒÑ€Ð¾Ð½ Ð¸Ð³Ñ€Ð¾ÐºÐ° Ð¸Ð· ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸:

```ts
baseMin = player.attack.min;
baseMax = player.attack.max;
```

- ÑÑ‚Ð¾ **Ñ‡Ð¸ÑÑ‚Ñ‹Ð¹ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½** ÑƒÑ€Ð¾Ð½Ð° Ð¾Ñ€ÑƒÐ¶Ð¸ÐµÐ¼;
- Ð´Ð»Ñ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð³Ð¾ ÑƒÐ´Ð°Ñ€Ð° (ab0) Ð¿Ñ€Ð¾Ñ†ÐµÐ½Ñ‚Ñ‹ ÑÑ‚Ð¸Ñ…Ð¸Ð¹ Ð½Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÑŽÑ‚ÑÑ, ÐºÐ¾ÑÑ„Ñ„Ð¸Ñ†Ð¸ÐµÐ½Ñ‚ Ð²ÑÐµÐ³Ð´Ð° `1.0`.

---

## 2. Ð Ð¾Ð»Ð» ÑƒÑ€Ð¾Ð½Ð° Ñ ÑƒÑ‡Ñ‘Ñ‚Ð¾Ð¼ ÑƒÐ´Ð°Ñ‡Ð¸

```ts
function rollByLuck(minVal, maxVal, luck) {
  const L = clamp(luck / 100, 0, 1); // Ð½Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑƒÐ´Ð°Ñ‡Ñƒ Ð² 0..1
  const exp = Math.max(0.3, 1 - 0.7 * L); // ÑÐºÑÐ¿Ð¾Ð½ÐµÐ½Ñ‚Ð° Ð¾Ñ‚ 1.0 Ð´Ð¾ 0.3
  const u = Math.random() ** exp; // Ñ‡ÐµÐ¼ Ð¼ÐµÐ½ÑŒÑˆÐµ exp, Ñ‚ÐµÐ¼ Ð±Ð»Ð¸Ð¶Ðµ u Ðº 1
  return Math.round(minVal + (maxVal - minVal) * u);
}
```

**ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹:**

- ÐŸÑ€Ð¸ `luck=0` â†’ `exp=1` â†’ `u=random` â†’ Ñ€Ð°Ð²Ð½Ð¾Ð¼ÐµÑ€Ð½Ð¾Ðµ Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð² \[min,max].
- ÐŸÑ€Ð¸ `luck=100` â†’ `exp=0.3` â†’ `u=random^0.3` â†’ ÑÐ¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð² ÑÑ‚Ð¾Ñ€Ð¾Ð½Ñƒ **Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼Ð°**.
- Ð¢Ð°ÐºÐ¸Ð¼ Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð¼, ÑƒÐ´Ð°Ñ‡Ð° **Ð½Ðµ ÑƒÐ²ÐµÐ»Ð¸Ñ‡Ð¸Ð²Ð°ÐµÑ‚ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½**, Ð° Ð¼ÐµÐ½ÑÐµÑ‚ Ñ€Ð°ÑÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ: ÑƒÑ€Ð¾Ð½ Ñ‡Ð°Ñ‰Ðµ Ð±Ð»Ð¸Ð¶Ðµ Ðº `max`.

---

## 3. ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÑƒÐ´Ð°Ñ€

```ts
function getCritFromLuck(luck) {
  const pct = Math.floor(luck / 10); // ÐºÐ°Ð¶Ð´Ñ‹Ðµ 10 ÑƒÐ´Ð°Ñ‡Ð¸ = +1% ÐºÑ€Ð¸Ñ‚
  const did = Math.random() * 100 < pct;
  return { critMul: did ? 2 : 1, didCrit: did, critPct: pct };
}
```

**ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹:**

- ÐŸÑ€Ð¸ `luck=8` â†’ ÑˆÐ°Ð½Ñ ÐºÑ€Ð¸Ñ‚Ð° 0%.
- ÐŸÑ€Ð¸ `luck=80` â†’ ÑˆÐ°Ð½Ñ ÐºÑ€Ð¸Ñ‚Ð° 8%.
- ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÑƒÐ´Ð°Ñ€ **ÑƒÐ´Ð²Ð°Ð¸Ð²Ð°ÐµÑ‚** Ð¸Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ ÑƒÑ€Ð¾Ð½.

---

## 4. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¿Ñ€Ð¾Ð¼Ð°Ñ…

Ð’ Ð¾Ñ€ÑƒÐ¶Ð¸Ð¸ ÐµÑÑ‚ÑŒ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¿Ñ€Ð¾Ð¼Ð°Ñ…Ð¾Ð² Ð¿Ð¾ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸ÑÐ¼ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, `[15,30,45,60]`):

```ts
function getMissForWeapon(weapon, posIdx, luck) {
  const base = weapon.miss.baseByPos[posIdx - 1];
  const step = weapon.miss.luckStep ?? 10; // ÐºÐ°Ð¶Ð´Ñ‹Ðµ 10 ÑƒÐ´Ð°Ñ‡Ð¸
  const per = weapon.miss.luckPerStepPct ?? 1; // ÑÐ½Ð¸Ð¶Ð°ÐµÐ¼ ÑˆÐ°Ð½Ñ Ð¿Ñ€Ð¾Ð¼Ð°Ñ…Ð° Ð½Ð° 1%
  const steps = Math.floor(luck / step);
  const missPct = Math.max(0, base - steps * per);
  const didMiss = Math.random() * 100 < missPct;
  return { missPct, didMiss };
}
```

**ÐšÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¹:**

- ÐŸÑ€Ð¸ `luck=0` â†’ Ð±ÐµÑ€Ñ‘Ð¼ `base`.
- ÐŸÑ€Ð¸ `luck=100` â†’ ÑˆÐ°Ð½Ñ Ð¿Ñ€Ð¾Ð¼Ð°Ñ…Ð° ÑƒÐ¼ÐµÐ½ÑŒÑˆÐ°ÐµÑ‚ÑÑ Ð½Ð° 10% (10 ÑˆÐ°Ð³Ð¾Ð² Ã— 1%).
- ÐŸÑ€Ð¾Ð¼Ð°Ñ… Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ Ð¾Ð±Ð½ÑƒÐ»ÑÐµÑ‚ ÑƒÑ€Ð¾Ð½.

---

## 5. Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼ÑƒÐ»Ð°

1. Ð Ð¾Ð»Ð»Ð¸Ð¼ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ ÑƒÑ€Ð¾Ð½:

   ```
   roll = rollByLuck(baseMin, baseMax, luck)
   ```

2. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÑ€Ð¸Ñ‚:

   ```
   rollCrit = roll * critMul   // critMul = 1 Ð¸Ð»Ð¸ 2
   ```

3. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð¾Ð¼Ð°Ñ…:

   ```
   finalDamage = didMiss ? 0 : rollCrit
   ```

---

## ðŸ”Ž ÐŸÑ€Ð¸Ð¼ÐµÑ€

Ð˜Ð³Ñ€Ð¾Ðº:

- `attack.min=20, attack.max=40`
- `luck=80`

ÐžÑ€ÑƒÐ¶Ð¸Ðµ (Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ñ 3):

- `miss.baseByPos=[15,30,45,60]`
- Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ base=45% Ð¿Ñ€Ð¾Ð¼Ð°Ñ…Ð°.

**Ð Ð°ÑÑ‡Ñ‘Ñ‚:**

1. Ð Ð¾Ð»Ð»: `rollByLuck(20,40,80)` â†’ Ñ‡Ð°Ñ‰Ðµ Ð±Ð»Ð¸Ð¶Ðµ Ðº 40.
2. ÐšÑ€Ð¸Ñ‚: ÑˆÐ°Ð½Ñ 8%. Ð•ÑÐ»Ð¸ Ð²Ñ‹Ð¿Ð°Ð» â€” Ã—2.
3. ÐŸÑ€Ð¾Ð¼Ð°Ñ…: ÑˆÐ°Ð½Ñ = 45% âˆ’ 8% = 37%.

Ð˜Ñ‚Ð¾Ð³Ð¾:

- Ð£Ñ€Ð¾Ð½ 0 (ÐœÐ˜ÐœÐž) Ñ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒÑŽ 37%.
- Ð£Ñ€Ð¾Ð½ 20â€“40 (ÑÑ€ÐµÐ´Ð½ÐµÐµ Ð±Ð»Ð¸Ð¶Ðµ Ðº 38) Ñ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒÑŽ \~55%.
- Ð£Ñ€Ð¾Ð½ 40â€“80 (ÐºÑ€Ð¸Ñ‚) Ñ Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒÑŽ \~8%.
=======

>>>>>>> de179f74d7756bbfe9cf9ce16e4246a6d7b53623
